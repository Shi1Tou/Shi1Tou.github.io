<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个性化导航页</title>
    <style>
        /* 保留原有样式，新增以下样式 */
        .network-type {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            background: #6366f1;
            color: white;
            border-radius: 3px;
        }
        .network-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: white;
        }
        .network-switch select {
            padding: 0.4rem;
            border-radius: 4px;
            border: none;
        }
        .form-container .network-option {
            min-width: 150px;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- 登录容器（不变） -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>请输入访问密码</h2>
            <input type="password" id="loginPassword" placeholder="密码" required>
            <button onclick="verifyPassword()">登录</button>
        </div>
    </div>

    <div class="container" id="mainContent" class="hidden">
        <h1>我的个性化导航页</h1>

        <!-- 新增：网络类型切换器（仅管理员可见） -->
        <div class="network-switch" id="networkSwitch" style="display: none;">
            <span>网络类型：</span>
            <select id="networkTypeSelect" onchange="switchNetworkType()">
                <option value="auto">自动检测</option>
                <option value="internal">内网</option>
                <option value="external">外网</option>
            </select>
        </div>

        <!-- 顶部控制区（不变） -->
        <div class="top-controls">
            <div class="bg-config">
                <input type="url" id="bgImageUrl" placeholder="输入背景图片API链接（如Unsplash）">
                <button onclick="setBackground()">设置背景</button>
                <button onclick="resetBackground()">重置</button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索链接...">
                <button onclick="searchLinks()">搜索</button>
            </div>
        </div>

        <!-- 分类标签（不变） -->
        <div class="category-tabs" id="categoryTabs">
            <button class="category-tab active" data-category="all">全部</button>
        </div>

        <!-- 链接网格（不变） -->
        <div class="link-grid" id="linkContainer"></div>

        <!-- 添加链接表单（新增内网/外网URL设置） -->
        <div class="form-container">
            <h3>添加新链接</h3>
            <form id="addLinkForm">
                <input type="text" name="name" placeholder="链接名称" required>
                <input type="url" name="externalUrl" placeholder="外网链接（如https://example.com）" required>
                <input type="text" name="internalUrl" placeholder="内网链接（如http://192.168.1.100）" required>
                <select name="category" required>
                    <option value="工作">工作</option>
                    <option value="学习">学习</option>
                    <option value="娱乐">娱乐</option>
                    <option value="工具">工具</option>
                    <option value="其他">其他</option>
                </select>
                <select name="visibility" class="visibility-option" required>
                    <option value="public">公开（所有人可见）</option>
                    <option value="private">仅管理员可见</option>
                </select>
                <button type="submit">添加</button>
            </form>
        </div>
    </div>

    <script>
        let allLinks = [];
        let currentCategory = 'all';
        let currentNetworkType = 'auto'; // 默认为自动检测
        const AUTH_TOKEN = 'valid_token';
        let isAdmin = false;

        // 页面加载时初始化
        window.onload = () => {
            const auth = localStorage.getItem('auth');
            if (auth === AUTH_TOKEN) {
                isAdmin = true;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('networkSwitch').style.display = 'flex'; // 显示网络切换器
                loadSavedBackground();
                loadLinks();
            } else {
                isAdmin = false;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadSavedBackground();
                loadPublicLinks();
            }
        };

        // 自动检测网络类型（简单判断：内网IP段）
        function detectNetworkType() {
            // 实际应用中可通过检测内网IP或特定域名可达性实现
            const internalIps = ['192.168.', '10.', '172.16.'];
            return new Promise(resolve => {
                // 模拟检测（实际项目可替换为真实IP检测）
                setTimeout(() => {
                    resolve('external'); // 默认返回外网，可根据需求修改
                }, 500);
            });
        }

        // 切换网络类型
        async function switchNetworkType() {
            currentNetworkType = document.getElementById('networkTypeSelect').value;
            if (currentNetworkType === 'auto') {
                currentNetworkType = await detectNetworkType();
            }
            renderLinks(allLinks);
        }

        // 密码验证（管理员登录）
        async function verifyPassword() {
            const inputPwd = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: inputPwd })
                });
                if (res.ok) {
                    localStorage.setItem('auth', AUTH_TOKEN);
                    isAdmin = true;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('networkSwitch').style.display = 'flex';
                    loadLinks();
                } else {
                    alert('密码错误，仅管理员可查看私有链接');
                }
            } catch (e) {
                alert('验证失败');
            }
        }

        // 未登录用户加载公开链接（仅外网）
        async function loadPublicLinks() {
            const res = await fetch('/api/links/public');
            allLinks = await res.json();
            renderLinks(allLinks);
            renderCategories();
        }

        // 管理员加载所有链接
        async function loadLinks() {
            const auth = localStorage.getItem('auth');
            if (!auth) return;
            const res = await fetch('/api/links', {
                headers: { 'Authorization': `Bearer ${auth}` }
            });
            if (res.status === 401) {
                alert('登录已过期');
                localStorage.removeItem('auth');
                isAdmin = false;
                document.getElementById('networkSwitch').style.display = 'none';
                loadPublicLinks();
                return;
            }
            allLinks = await res.json();
            // 自动检测网络类型
            if (currentNetworkType === 'auto') {
                currentNetworkType = await detectNetworkType();
                document.getElementById('networkTypeSelect').value = 'auto';
            }
            renderLinks(allLinks);
            renderCategories();
        }

        // 渲染链接（根据网络类型选择URL）
        function renderLinks(links) {
            const container = document.getElementById('linkContainer');
            container.innerHTML = '';
            if (links.length === 0) {
                container.innerHTML = '<div style="color:white; grid-column: 1/-1; text-align: center;">暂无链接</div>';
                return;
            }

            // 确定当前使用的网络类型
            const activeNetworkType = currentNetworkType === 'auto' ? 'external' : currentNetworkType;

            links.forEach(link => {
                // 选择显示的URL
                const displayUrl = activeNetworkType === 'internal' ? link.internalUrl : link.externalUrl;
                const networkLabel = activeNetworkType === 'internal' ? '内网' : '外网';

                const card = document.createElement('div');
                card.className = 'link-card';
                card.innerHTML = `
                    <span class="category-tag">${link.category}</span>
                    <span class="visibility-tag ${link.visibility === 'public' ? 'public' : ''}">
                        ${link.visibility === 'public' ? '公开' : '私有'}
                    </span>
                    <span class="network-type">${networkLabel}</span>
                    <a href="${displayUrl}" target="_blank">${link.name}</a>
                    ${isAdmin ? `<button class="delete-btn" data-id="${link.id}">删除</button>` : ''}
                `;
                container.appendChild(card);
            });

            // 管理员删除事件
            if (isAdmin) {
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        await fetch(`/api/links/${id}`, { 
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('auth')}` }
                        });
                        loadLinks();
                    });
                });
            }
        }

        // 添加链接（包含内网/外网URL）
        document.getElementById('addLinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) {
                alert('请登录管理员账号添加链接');
                return;
            }
            const formData = new FormData(e.target);
            const link = {
                id: Date.now().toString(),
                name: formData.get('name'),
                externalUrl: formData.get('externalUrl'), // 外网URL
                internalUrl: formData.get('internalUrl'), // 内网URL
                category: formData.get('category'),
                visibility: formData.get('visibility')
            };
            await fetch('/api/links', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('auth')}`
                },
                body: JSON.stringify(link)
            });
            e.target.reset();
            loadLinks();
        });

        // 其余函数（背景设置、搜索、分类等）保持不变
        function setBackground() {
            const url = document.getElementById('bgImageUrl').value;
            if (url) {
                document.body.style.backgroundImage = `url(${url})`;
                localStorage.setItem('bgImageUrl', url);
            } else {
                alert('请输入有效的图片链接！');
            }
        }

        function resetBackground() {
            document.body.style.backgroundImage = '';
            localStorage.removeItem('bgImageUrl');
            document.getElementById('bgImageUrl').value = '';
        }

        function loadSavedBackground() {
            const savedUrl = localStorage.getItem('bgImageUrl');
            if (savedUrl) {
                document.body.style.backgroundImage = `url(${savedUrl})`;
                document.getElementById('bgImageUrl').value = savedUrl;
            }
        }

        function renderCategories() {
            const categories = ['工作', '学习', '娱乐', '工具', '其他'];
            const tabContainer = document.getElementById('categoryTabs');
            tabContainer.innerHTML = '<button class="category-tab active" data-category="all">全部</button>';
            categories.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.dataset.category = cat;
                tab.textContent = cat;
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = cat;
                    const filteredLinks = allLinks.filter(link => link.category === cat);
                    renderLinks(filteredLinks);
                });
                tabContainer.appendChild(tab);
            });
        }

        function searchLinks() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            let filteredLinks = allLinks;
            if (currentCategory !== 'all') {
                filteredLinks = filteredLinks.filter(link => link.category === currentCategory);
            }
            if (keyword) {
                filteredLinks = filteredLinks.filter(link => 
                    link.name.toLowerCase().includes(keyword) || 
                    link.externalUrl.toLowerCase().includes(keyword) ||
                    link.internalUrl.toLowerCase().includes(keyword) ||
                    link.category.toLowerCase().includes(keyword)
                );
            }
            renderLinks(filteredLinks);
        }

        document.querySelector('.category-tab[data-category="all"]').addEventListener('click', () => {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.category-tab[data-category="all"]').classList.add('active');
            currentCategory = 'all';
            renderLinks(allLinks);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLinks();
        });
    </script>
</body>
</html>