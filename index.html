<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个性化导航页</title>
    <style>
        /* 保留所有原有样式，新增以下样式 */
        .import-export {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            justify-content: center;
        }
        .import-export button {
            padding: 0.6rem 1.2rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .import-export button:hover {
            background: #4338ca;
        }
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>请输入访问密码</h2>
            <input type="password" id="loginPassword" placeholder="密码" required>
            <button onclick="verifyPassword()">登录</button>
        </div>
    </div>

    <div class="container" id="mainContent" class="hidden">
        <h1>我的个性化导航页</h1>

        <div class="network-switch" id="networkSwitch" style="display: none;">
            <span>网络类型：</span>
            <select id="networkTypeSelect" onchange="switchNetworkType()">
                <option value="auto">自动检测</option>
                <option value="internal">内网</option>
                <option value="external">外网</option>
            </select>
        </div>

        <!-- 新增：导入导出按钮 -->
        <div class="import-export" id="importExportContainer" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">导入JSON书签</button>
            <button onclick="exportBookmarks()">导出JSON书签</button>
            <input type="file" id="fileInput" accept=".json" onchange="importBookmarks(event)">
        </div>

        <div class="top-controls">
            <div class="bg-config">
                <input type="url" id="bgImageUrl" placeholder="输入背景图片API链接（如Unsplash）">
                <button onclick="setBackground()">设置背景</button>
                <button onclick="resetBackground()">重置</button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索链接...">
                <button onclick="searchLinks()">搜索</button>
            </div>
        </div>

        <div class="category-tabs" id="categoryTabs">
            <button class="category-tab active" data-category="all">全部</button>
        </div>

        <div class="link-grid" id="linkContainer"></div>

        <div class="form-container">
            <h3>添加新链接</h3>
            <form id="addLinkForm">
                <input type="text" name="name" placeholder="链接名称" required>
                <div>
                    <input type="url" name="externalUrl" placeholder="外网链接（必填，如https://example.com）" required>
                </div>
                <div>
                    <input type="text" name="internalUrl" placeholder="内网链接（可选，如http://192.168.1.100）">
                    <div class="optional-hint">内网链接为可选</div>
                </div>
                <select name="category" required>
                    <option value="工作">工作</option>
                    <option value="学习">学习</option>
                    <option value="娱乐">娱乐</option>
                    <option value="工具">工具</option>
                    <option value="其他">其他</option>
                </select>
                <select name="visibility" class="visibility-option" required>
                    <option value="public">公开（所有人可见）</option>
                    <option value="private">仅管理员可见</option>
                </select>
                <button type="submit">添加</button>
            </form>
        </div>
    </div>

    <script>
        let allLinks = [];
        let currentCategory = 'all';
        let currentNetworkType = 'auto';
        const AUTH_TOKEN = 'valid_token';
        let isAdmin = false;

        window.onload = () => {
            const auth = localStorage.getItem('auth');
            if (auth === AUTH_TOKEN) {
                isAdmin = true;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('networkSwitch').style.display = 'flex';
                document.getElementById('importExportContainer').style.display = 'flex'; // 显示导入导出按钮
                loadSavedBackground();
                loadLinks();
            } else {
                isAdmin = false;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadSavedBackground();
                loadPublicLinks();
            }
        };

        // 新增：导出书签为JSON文件
        function exportBookmarks() {
            if (!isAdmin) return;
            // 准备导出数据（添加导出时间）
            const exportData = {
                timestamp: new Date().toISOString(),
                links: allLinks
            };
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bookmarks_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 新增：导入JSON书签文件
        async function importBookmarks(event) {
            if (!isAdmin) return;
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    // 验证导入格式
                    if (!importData.links || !Array.isArray(importData.links)) {
                        throw new Error('JSON格式错误，缺少links数组');
                    }

                    // 批量添加书签（重复ID会被覆盖）
                    for (const link of importData.links) {
                        // 验证必要字段
                        if (!link.name || !link.externalUrl || !link.category || !link.visibility) {
                            console.warn(`跳过无效链接: ${link.name || '未知名称'}`);
                            continue;
                        }
                        // 生成新ID避免冲突（或保留原ID）
                        const linkWithId = {
                            ...link,
                            id: link.id || Date.now() + Math.random().toString(36).substr(2, 5)
                        };
                        await fetch('/api/links', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth')}`
                            },
                            body: JSON.stringify(linkWithId)
                        });
                    }

                    alert(`导入成功，共处理 ${importData.links.length} 个链接`);
                    loadLinks(); // 重新加载链接
                    event.target.value = ''; // 重置文件输入
                } catch (err) {
                    alert(`导入失败: ${err.message}`);
                }
            };
            reader.readAsText(file);
        }

        // 其余原有函数保持不变
        function detectNetworkType() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve('external');
                }, 500);
            });
        }

        function switchNetworkType() {
            currentNetworkType = document.getElementById('networkTypeSelect').value;
            if (currentNetworkType === 'auto') {
                detectNetworkType().then(type => {
                    currentNetworkType = type;
                    renderLinks(allLinks);
                });
            } else {
                renderLinks(allLinks);
            }
        }

        async function verifyPassword() {
            const inputPwd = document.getElementById('loginPassword').value;
            try {
                const res = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: inputPwd })
                });
                if (res.ok) {
                    localStorage.setItem('auth', AUTH_TOKEN);
                    isAdmin = true;
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('networkSwitch').style.display = 'flex';
                    document.getElementById('importExportContainer').style.display = 'flex';
                    loadLinks();
                } else {
                    alert('密码错误，仅管理员可查看私有链接');
                }
            } catch (e) {
                alert('验证失败');
            }
        }

        async function loadPublicLinks() {
            const res = await fetch('/api/links/public');
            allLinks = await res.json();
            renderLinks(allLinks);
            renderCategories();
        }

        async function loadLinks() {
            const auth = localStorage.getItem('auth');
            if (!auth) return;
            const res = await fetch('/api/links', {
                headers: { 'Authorization': `Bearer ${auth}` }
            });
            if (res.status === 401) {
                alert('登录已过期');
                localStorage.removeItem('auth');
                isAdmin = false;
                document.getElementById('networkSwitch').style.display = 'none';
                document.getElementById('importExportContainer').style.display = 'none';
                loadPublicLinks();
                return;
            }
            allLinks = await res.json();
            if (currentNetworkType === 'auto') {
                currentNetworkType = await detectNetworkType();
                document.getElementById('networkTypeSelect').value = 'auto';
            }
            renderLinks(allLinks);
            renderCategories();
        }

        function renderLinks(links) {
            const container = document.getElementById('linkContainer');
            container.innerHTML = '';
            if (links.length === 0) {
                container.innerHTML = '<div style="color:white; grid-column: 1/-1; text-align: center;">暂无链接</div>';
                return;
            }

            const activeNetworkType = currentNetworkType === 'auto' ? 'external' : currentNetworkType;

            links.forEach(link => {
                let displayUrl = link.externalUrl;
                let networkLabel = '外网';
                
                if (activeNetworkType === 'internal' && link.internalUrl) {
                    displayUrl = link.internalUrl;
                    networkLabel = '内网';
                }

                const card = document.createElement('div');
                card.className = 'link-card';
                card.innerHTML = `
                    <span class="category-tag">${link.category}</span>
                    <span class="visibility-tag ${link.visibility === 'public' ? 'public' : ''}">
                        ${link.visibility === 'public' ? '公开' : '私有'}
                    </span>
                    <span class="network-type">${networkLabel}</span>
                    <a href="${displayUrl}" target="_blank">${link.name}</a>
                    ${isAdmin ? `<button class="delete-btn" data-id="${link.id}">删除</button>` : ''}
                `;
                container.appendChild(card);
            });

            if (isAdmin) {
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        await fetch(`/api/links/${id}`, { 
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('auth')}` }
                        });
                        loadLinks();
                    });
                });
            }
        }

        document.getElementById('addLinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) {
                alert('请登录管理员账号添加链接');
                return;
            }
            const formData = new FormData(e.target);
            const link = {
                id: Date.now().toString(),
                name: formData.get('name'),
                externalUrl: formData.get('externalUrl'),
                internalUrl: formData.get('internalUrl') || '',
                category: formData.get('category'),
                visibility: formData.get('visibility')
            };
            await fetch('/api/links', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('auth')}`
                },
                body: JSON.stringify(link)
            });
            e.target.reset();
            loadLinks();
        });

        function setBackground() {
            const url = document.getElementById('bgImageUrl').value;
            if (url) {
                document.body.style.backgroundImage = `url(${url})`;
                localStorage.setItem('bgImageUrl', url);
            } else {
                alert('请输入有效的图片链接！');
            }
        }

        function resetBackground() {
            document.body.style.backgroundImage = '';
            localStorage.removeItem('bgImageUrl');
            document.getElementById('bgImageUrl').value = '';
        }

        function loadSavedBackground() {
            const savedUrl = localStorage.getItem('bgImageUrl');
            if (savedUrl) {
                document.body.style.backgroundImage = `url(${savedUrl})`;
                document.getElementById('bgImageUrl').value = savedUrl;
            }
        }

        function renderCategories() {
            const categories = ['工作', '学习', '娱乐', '工具', '其他'];
            const tabContainer = document.getElementById('categoryTabs');
            tabContainer.innerHTML = '<button class="category-tab active" data-category="all">全部</button>';
            categories.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.dataset.category = cat;
                tab.textContent = cat;
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = cat;
                    const filteredLinks = allLinks.filter(link => link.category === cat);
                    renderLinks(filteredLinks);
                });
                tabContainer.appendChild(tab);
            });
        }

        function searchLinks() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            let filteredLinks = allLinks;
            if (currentCategory !== 'all') {
                filteredLinks = filteredLinks.filter(link => link.category === currentCategory);
            }
            if (keyword) {
                filteredLinks = filteredLinks.filter(link => 
                    link.name.toLowerCase().includes(keyword) || 
                    link.externalUrl.toLowerCase().includes(keyword) ||
                    (link.internalUrl && link.internalUrl.toLowerCase().includes(keyword)) ||
                    link.category.toLowerCase().includes(keyword)
                );
            }
            renderLinks(filteredLinks);
        }

        document.querySelector('.category-tab[data-category="all"]').addEventListener('click', () => {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.category-tab[data-category="all"]').classList.add('active');
            currentCategory = 'all';
            renderLinks(allLinks);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLinks();
        });
    </script>
</body>
</html>